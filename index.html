<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strady . budget</title>
    <link rel="icon" type="image/svg+xml" href="./public/S-fav-icon.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .logo-strady { color: #228B22; } /* Vert Forêt */
        .logo-dot { color: #FF8C00; }    /* Orange */
        .logo-budget { color: #1E90FF; } /* Bleu Tech */
        .active-nav { @apply bg-blue-50 text-blue-600 font-semibold shadow-sm; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div id="app" class="min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar Navigation -->
        <nav class="md:w-64 bg-white border-r border-gray-200 p-4 flex flex-row md:flex-col gap-2 sticky top-0 z-40 h-auto md:h-screen">
            <div class="hidden md:block mb-8 px-2 py-4">
                <div class="flex items-center gap-1 text-xl font-bold tracking-tight">
                    <span class="logo-strady">Strady</span><span class="logo-dot">.</span><span class="logo-budget">budget</span>
                </div>
            </div>
            
            <div class="flex flex-row md:flex-col flex-1 gap-1 overflow-x-auto items-center md:items-stretch">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item flex items-center gap-3 p-3 rounded-xl transition-all text-gray-500 hover:bg-gray-100 whitespace-nowrap">
                    <i data-lucide="layout-dashboard"></i> <span class="hidden md:inline">Tableau de bord</span>
                </button>
                <button onclick="switchView('accounts')" id="nav-accounts" class="nav-item flex items-center gap-3 p-3 rounded-xl transition-all text-gray-500 hover:bg-gray-100 whitespace-nowrap">
                    <i data-lucide="wallet"></i> <span class="hidden md:inline">Mes Comptes</span>
                </button>
                <button onclick="switchView('profiles')" id="nav-profiles" class="nav-item flex items-center gap-3 p-3 rounded-xl transition-all text-gray-500 hover:bg-gray-100 whitespace-nowrap">
                    <i data-lucide="users"></i> <span class="hidden md:inline">Profils</span>
                </button>
                <button onclick="switchView('transactions')" id="nav-transactions" class="nav-item flex items-center gap-3 p-3 rounded-xl transition-all text-gray-500 hover:bg-gray-100 whitespace-nowrap">
                    <i data-lucide="arrow-left-right"></i> <span class="hidden md:inline">Transactions</span>
                </button>
            </div>

            <div class="hidden md:flex flex-col gap-2 mt-auto pt-4 border-t border-gray-100">
                <button onclick="exportData()" class="flex items-center gap-3 p-3 text-gray-500 hover:bg-gray-100 rounded-xl transition-colors">
                    <i data-lucide="download"></i> <span>Exporter</span>
                </button>
                <label class="flex items-center gap-3 p-3 text-gray-500 hover:bg-gray-100 rounded-xl cursor-pointer transition-colors">
                    <i data-lucide="upload"></i> <span>Importer</span>
                    <input type="file" onchange="importData(event)" class="hidden">
                </label>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full overflow-y-auto">
            <header class="flex justify-between items-center mb-8 md:hidden">
                <div class="flex items-center gap-1 text-xl font-bold tracking-tight">
                    <span class="logo-strady">Strady</span><span class="logo-dot">.</span><span class="logo-budget">budget</span>
                </div>
                <button onclick="showNotificationModal()" class="p-2 relative">
                    <i data-lucide="bell"></i>
                    <span id="notif-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
            </header>

            <!-- Views Container -->
            <div id="view-container">
                <!-- Content will be injected here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modal Notifications -->
    <div id="notif-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl overflow-hidden shadow-2xl">
            <div class="bg-orange-500 p-6 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i data-lucide="bell"></i>
                    <h2 class="text-xl font-bold">Rappels de budget</h2>
                </div>
                <button onclick="closeNotifModal()"><i data-lucide="x"></i></button>
            </div>
            <div id="notif-list" class="p-6 max-h-[60vh] overflow-y-auto space-y-4">
                <!-- Notifications injected here -->
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end">
                <button onclick="closeNotifModal()" class="px-6 py-2 font-bold text-gray-500 hover:text-gray-800">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const INITIAL_DATA = {
            profiles: [],
            accounts: [],
            transactions: [],
            filters: {
                profileIds: [],
                accountIds: [],
                categories: [],
                period: 'monthly'
            }
        };

        let data = JSON.parse(localStorage.getItem('strady_budget_data')) || INITIAL_DATA;
        let currentView = 'dashboard';

        const CATEGORIES = ["Alimentation", "Loisirs", "Logement", "Santé", "Transport", "Salaire", "Épargne", "Autre"];

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('strady_budget_data', JSON.stringify(data));
        }

        function switchView(viewId) {
            currentView = viewId;
            render();
        }

        function render() {
            // Update Navigation UI
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-blue-50', 'text-blue-600', 'font-semibold'));
            const activeNav = document.getElementById(`nav-${currentView}`);
            if (activeNav) activeNav.classList.add('bg-blue-50', 'text-blue-600', 'font-semibold');

            const container = document.getElementById('view-container');
            
            if (currentView === 'dashboard') renderDashboard(container);
            if (currentView === 'accounts') renderAccounts(container);
            if (currentView === 'profiles') renderProfiles(container);
            if (currentView === 'transactions') renderTransactions(container);

            lucide.createIcons();
            checkNotificationsBadge();
        }

        // --- DASHBOARD VIEW ---
        function renderDashboard(container) {
            const filtered = data.transactions.filter(t => {
                const acc = data.accounts.find(a => a.id === t.accountId);
                const matchProfile = data.filters.profileIds.length === 0 || 
                    (acc && acc.owners.some(oid => data.filters.profileIds.includes(oid)));
                const matchAccount = data.filters.accountIds.length === 0 || data.filters.accountIds.includes(t.accountId);
                return matchProfile && matchAccount;
            });

            let income = 0; let expenses = 0;
            filtered.forEach(t => {
                const val = parseFloat(t.amount);
                if (t.type === 'in') income += val; else expenses += val;
            });

            container.innerHTML = `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h1 class="text-2xl font-bold">Tableau de bord</h1>
                        <div class="flex gap-2">
                             <button onclick="resetFilters()" class="p-2 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x"></i></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-gray-500 text-sm font-medium mb-1">Total Revenus</p>
                            <p class="text-2xl font-bold text-green-600">+${income.toLocaleString()} €</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-gray-500 text-sm font-medium mb-1">Total Dépenses</p>
                            <p class="text-2xl font-bold text-red-600">-${expenses.toLocaleString()} €</p>
                        </div>
                        <div class="bg-blue-600 p-6 rounded-2xl shadow-lg text-white">
                            <p class="text-blue-100 text-sm font-medium mb-1">Disponibilité Totale</p>
                            <p class="text-2xl font-bold">${(income - expenses).toLocaleString()} €</p>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-2xl border border-gray-100 flex flex-wrap gap-4 items-center">
                        <div class="flex items-center gap-2 text-sm text-gray-500"><i data-lucide="filter" size="16"></i> <span>Filtres :</span></div>
                        <select onchange="updateFilter('profileIds', Array.from(this.selectedOptions, o => o.value))" multiple class="text-sm bg-gray-50 border-none rounded-lg px-2 py-1 outline-none min-w-[120px]">
                            <option value="" disabled>Profils</option>
                            ${data.profiles.map(p => `<option value="${p.id}" ${data.filters.profileIds.includes(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <select onchange="updateFilter('accountIds', Array.from(this.selectedOptions, o => o.value))" multiple class="text-sm bg-gray-50 border-none rounded-lg px-2 py-1 outline-none min-w-[120px]">
                            <option value="" disabled>Comptes</option>
                            ${data.accounts.map(a => `<option value="${a.id}" ${data.filters.accountIds.includes(a.id) ? 'selected' : ''}>${a.name}</option>`).join('')}
                        </select>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                            <h3 class="font-semibold">Mouvements récents</h3>
                            <button onclick="switchView('transactions')" class="text-sm text-blue-600 font-medium">Voir tout</button>
                        </div>
                        <div class="divide-y divide-gray-100">
                            ${filtered.slice(0, 5).map(t => `
                                <div class="p-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div class="flex gap-3 items-center">
                                        <div class="p-2 rounded-lg ${t.type === 'in' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}">
                                            <i data-lucide="arrow-left-right" size="18"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${t.label}</p>
                                            <p class="text-xs text-gray-400">${t.category} • ${new Date(t.date).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <p class="font-bold ${t.type === 'in' ? 'text-green-600' : 'text-gray-900'}">
                                        ${t.type === 'in' ? '+' : '-'}${parseFloat(t.amount).toLocaleString()} €
                                    </p>
                                </div>
                            `).join('')}
                            ${filtered.length === 0 ? '<div class="p-8 text-center text-gray-400">Aucune transaction trouvée.</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- PROFILES VIEW ---
        function renderProfiles(container) {
            container.innerHTML = `
                <div class="space-y-6">
                    <h1 class="text-2xl font-bold">Gestion des Profils</h1>
                    <form onsubmit="handleProfileAdd(event)" class="flex gap-2">
                        <input name="name" required placeholder="Nom du profil (ex: Mao)" class="flex-1 bg-white border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-green-500" />
                        <button type="submit" class="bg-[#228B22] text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2">
                            <i data-lucide="plus"></i> Ajouter
                        </button>
                    </form>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        ${data.profiles.map(p => `
                            <div class="bg-white p-6 rounded-2xl border border-gray-100 flex justify-between items-center group">
                                <span class="font-semibold text-lg">${p.name}</span>
                                <button onclick="deleteProfile('${p.id}')" class="text-gray-300 hover:text-red-500 transition-colors">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function handleProfileAdd(e) {
            e.preventDefault();
            const name = e.target.name.value;
            data.profiles.push({ id: crypto.randomUUID(), name });
            saveData();
            render();
        }

        function deleteProfile(id) {
            data.profiles = data.profiles.filter(p => p.id !== id);
            data.accounts.forEach(a => a.owners = a.owners.filter(oid => oid !== id));
            saveData();
            render();
        }

        // --- ACCOUNTS VIEW ---
        function renderAccounts(container) {
            container.innerHTML = `
                <div class="space-y-6">
                    <h1 class="text-2xl font-bold">Mes Comptes de Réserve</h1>
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 space-y-4">
                        <h2 class="font-semibold text-lg">Nouveau Compte</h2>
                        <form onsubmit="handleAccountAdd(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input name="name" required placeholder="Nom du compte" class="bg-gray-50 border-none rounded-xl px-4 py-3" />
                            <input name="balance" type="number" step="0.01" required placeholder="Solde Initial (€)" class="bg-gray-50 border-none rounded-xl px-4 py-3" />
                            <select name="owners" multiple required class="bg-gray-50 border-none rounded-xl px-4 py-3 min-h-[100px]">
                                ${data.profiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-[#1E90FF] text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2">
                                    <i data-lucide="plus"></i> Créer le compte
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${data.accounts.map(acc => {
                            const accTransactions = data.transactions.filter(t => t.accountId === acc.id);
                            const currentBalance = parseFloat(acc.initialBalance) + accTransactions.reduce((bal, t) => t.type === 'in' ? bal + parseFloat(t.amount) : bal - parseFloat(t.amount), 0);
                            return `
                                <div class="bg-white p-6 rounded-2xl border border-gray-100 flex flex-col justify-between hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="font-bold text-xl">${acc.name}</h3>
                                            <div class="flex flex-wrap gap-1 mt-1">
                                                ${acc.owners.map(oid => `<span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full uppercase font-bold">${data.profiles.find(p => p.id === oid)?.name || 'Inconnu'}</span>`).join('')}
                                            </div>
                                        </div>
                                        <span class="text-xl font-mono font-bold ${currentBalance < 0 ? 'text-red-500' : 'text-gray-900'}">${currentBalance.toLocaleString()} €</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-4 border-t pt-2 flex justify-between">
                                        <span>Initial : ${acc.initialBalance} €</span>
                                        <button onclick="deleteAccount('${acc.id}')" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" size="14"></i></button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function handleAccountAdd(e) {
            e.preventDefault();
            const owners = Array.from(e.target.owners.selectedOptions, o => o.value);
            data.accounts.push({
                id: crypto.randomUUID(),
                name: e.target.name.value,
                initialBalance: e.target.balance.value,
                owners
            });
            saveData();
            render();
        }

        function deleteAccount(id) {
            data.accounts = data.accounts.filter(a => a.id !== id);
            data.transactions = data.transactions.filter(t => t.accountId !== id);
            saveData();
            render();
        }

        // --- TRANSACTIONS VIEW ---
        function renderTransactions(container) {
            container.innerHTML = `
                <div class="space-y-6">
                    <h1 class="text-2xl font-bold">Gestion des Transactions</h1>
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <form onsubmit="handleTransactionAdd(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select name="accountId" required class="bg-gray-50 border-none rounded-xl px-4 py-3">
                                <option value="">Choisir un compte</option>
                                ${data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
                            </select>
                            <input name="label" required placeholder="Libellé" class="bg-gray-50 border-none rounded-xl px-4 py-3" />
                            <div class="flex">
                                <select name="type" class="bg-gray-100 border-none rounded-l-xl px-2 py-3 text-sm font-bold">
                                    <option value="out">Débit (-)</option>
                                    <option value="in">Crédit (+)</option>
                                </select>
                                <input name="amount" type="number" step="0.01" required placeholder="Montant" class="bg-gray-50 border-none rounded-r-xl px-4 py-3 flex-1" />
                            </div>
                            <select name="category" required class="bg-gray-50 border-none rounded-xl px-4 py-3">
                                ${CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                            <input name="date" type="date" required class="bg-gray-50 border-none rounded-xl px-4 py-3" value="${new Date().toISOString().split('T')[0]}" />
                            <select name="frequency" class="bg-gray-50 border-none rounded-xl px-4 py-3">
                                <option value="once">Ponctuelle</option>
                                <option value="monthly">Mensuelle</option>
                            </select>
                            <div class="col-span-1 md:col-span-3 flex items-center gap-4 bg-gray-50 p-4 rounded-xl">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" name="isNotifiable" class="w-5 h-5 accent-orange-500" />
                                    <span class="text-sm font-medium">Notifier avant échéance</span>
                                </label>
                                <input name="notifyDays" type="number" placeholder="Jours avant" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-sm w-24" />
                            </div>
                            <button type="submit" class="col-span-1 md:col-span-3 bg-gray-900 text-white py-4 rounded-xl font-bold hover:bg-black transition-colors">Enregistrer</button>
                        </form>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-100 overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Libellé</th>
                                    <th class="p-4">Compte</th>
                                    <th class="p-4">Montant</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${data.transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="p-4 text-sm">${new Date(t.date).toLocaleDateString()}</td>
                                        <td class="p-4"><div class="font-medium">${t.label}</div><div class="text-[10px] text-gray-400">${t.category}</div></td>
                                        <td class="p-4 text-sm">${data.accounts.find(a => a.id === t.accountId)?.name || '-'}</td>
                                        <td class="p-4 font-bold ${t.type === 'in' ? 'text-green-600' : 'text-gray-900'}">${t.type === 'in' ? '+' : '-'}${parseFloat(t.amount).toLocaleString()} €</td>
                                        <td class="p-4">
                                            <button onclick="deleteTransaction('${t.id}')" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function handleTransactionAdd(e) {
            e.preventDefault();
            data.transactions.push({
                id: crypto.randomUUID(),
                accountId: e.target.accountId.value,
                label: e.target.label.value,
                amount: e.target.amount.value,
                type: e.target.type.value,
                category: e.target.category.value,
                date: e.target.date.value,
                frequency: e.target.frequency.value,
                isNotifiable: e.target.isNotifiable.checked,
                notifyDaysBefore: parseInt(e.target.notifyDays.value) || 0,
                status: 'pending'
            });
            saveData();
            render();
        }

        function deleteTransaction(id) {
            data.transactions = data.transactions.filter(t => t.id !== id);
            saveData();
            render();
        }

        // --- FILTERS ---
        function updateFilter(key, value) {
            data.filters[key] = value;
            saveData();
            render();
        }

        function resetFilters() {
            data.filters = { ...INITIAL_DATA.filters };
            saveData();
            render();
        }

        // --- IMPORT / EXPORT ---
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `strady-budget-export.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    data = JSON.parse(e.target.result);
                    saveData();
                    render();
                } catch (err) { alert("Format invalide"); }
            };
            reader.readAsText(file);
        }

        // --- NOTIFICATIONS SYSTEM ---
        function checkNotificationsBadge() {
            const today = new Date();
            const alertes = data.transactions.filter(t => {
                if (t.status !== 'pending' || !t.isNotifiable) return false;
                const tDate = new Date(t.date);
                const diffDays = Math.ceil((tDate - today) / (1000 * 60 * 60 * 24));
                return diffDays <= t.notifyDaysBefore;
            });
            const badge = document.getElementById('notif-badge');
            if (alertes.length > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            return alertes;
        }

        function showNotificationModal() {
            const alertes = checkNotificationsBadge();
            const list = document.getElementById('notif-list');
            list.innerHTML = alertes.map(n => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                    <div>
                        <p class="font-bold text-gray-900">${n.label}</p>
                        <p class="text-xs text-gray-500">Échéance : ${new Date(n.date).toLocaleDateString()}</p>
                        <p class="text-sm font-bold mt-1 text-red-600">${n.amount} €</p>
                    </div>
                    <button onclick="markDone('${n.id}')" class="p-3 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors">
                        <i data-lucide="check-circle-2"></i>
                    </button>
                </div>
            `).join('') || '<p class="text-center text-gray-400">Aucune notification.</p>';
            document.getElementById('notif-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function markDone(id) {
            const t = data.transactions.find(x => x.id === id);
            if (t) t.status = 'completed';
            saveData();
            showNotificationModal();
            render();
        }

        function closeNotifModal() {
            document.getElementById('notif-modal').classList.add('hidden');
        }

        // --- INIT ---
        window.onload = () => {
            render();
            const alertes = checkNotificationsBadge();
            if (alertes.length > 0) showNotificationModal();
        };
    </script>
</body>
</html>